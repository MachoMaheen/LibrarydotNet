<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Library Management System</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <h1>ðŸ“š Library Management System</h1>
            <nav id="userInfo"></nav>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard">
            <h2 class="mb-2">Admin Dashboard</h2>

            <div id="alert" class="alert"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3 id="totalBooksCount">0</h3>
                    <p>Total Books</p>
                </div>
                <div class="stat-card">
                    <h3 id="availableBooksCount">0</h3>
                    <p>Available Books</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Add New Book</div>
                <form id="addBookForm" onsubmit="handleAddBook(event)" class="mt-1">
                    <div class="form-group">
                        <label for="isbn">ISBN *</label>
                        <input type="text" id="isbn" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="author">Author *</label>
                        <input type="text" id="author" required>
                    </div>
                    <div class="form-group">
                        <label for="publisher">Publisher</label>
                        <input type="text" id="publisher">
                    </div>
                    <div class="form-group">
                        <label for="publishedYear">Published Year</label>
                        <input type="number" id="publishedYear" min="1900" max="2100">
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="">Select Category</option>
                            <option value="Programming">Programming</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Database">Database</option>
                            <option value="Web Development">Web Development</option>
                            <option value="Mobile Development">Mobile Development</option>
                            <option value="DevOps">DevOps</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="totalCopies">Total Copies *</label>
                        <input type="number" id="totalCopies" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><span>Add Book</span></button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Book Inventory</div>
                <div class="search-bar">
                    <input type="text" id="searchTerm" placeholder="Search books...">
                    <button class="btn btn-primary" onclick="loadBooks()"><span>Search</span></button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Total</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="booksTable">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="./js/app.js"></script> -->
    <script>
        // if (!requireRole('Admin')) {
        //     // Will redirect
        // }

        async function handleAddBook(event) {
            event.preventDefault();

            const data = {
                isbn: document.getElementById('isbn').value,
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                publisher: document.getElementById('publisher').value || null,
                publishedYear: document.getElementById('publishedYear').value ?
                    parseInt(document.getElementById('publishedYear').value) : null,
                category: document.getElementById('category').value || null,
                totalCopies: parseInt(document.getElementById('totalCopies').value),
                description: document.getElementById('description').value || null
            };

            try {
                showLoading(true);
                await apiRequest('/Books', 'POST', data);
                showAlert('Book added successfully!', 'success');
                document.getElementById('addBookForm').reset();
                loadBooks();
            } catch (error) {
                showAlert('Failed to add book: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadBooks() {
            try {
                showLoading(true);
                const searchTerm = document.getElementById('searchTerm').value;

                const url = searchTerm
                    ? `/Books/search?searchTerm=${encodeURIComponent(searchTerm)}`
                    : '/Books';

                const books = await apiRequest(url);
                displayBooks(books);
                updateStats(books);
            } catch (error) {
                showAlert('Failed to load books: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayBooks(books) {
            const tbody = document.getElementById('booksTable');

            if (books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No books found</td></tr>';
                return;
            }

            tbody.innerHTML = books.map(book => `
                <tr>
                    <td>${book.bookId}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.category || 'N/A'}</td>
                    <td>${book.totalCopies}</td>
                    <td>${book.availableCopies}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.bookId})"><span>Delete</span></button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(books) {
            const totalBooks = books.reduce((sum, book) => sum + book.totalCopies, 0);
            const availableBooks = books.reduce((sum, book) => sum + book.availableCopies, 0);

            document.getElementById('totalBooksCount').textContent = totalBooks;
            document.getElementById('availableBooksCount').textContent = availableBooks;
        }

        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) {
                return;
            }

            try {
                showLoading(true);
                await apiRequest(`/Books/${bookId}`, 'DELETE');
                showAlert('Book deleted successfully!', 'success');
                loadBooks();
            } catch (error) {
                showAlert('Failed to delete book: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', loadBooks);
    </script>
</body>

</html>