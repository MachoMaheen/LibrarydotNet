<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard - Library Management System</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <h1>ðŸ“š Library Management System</h1>
            <nav id="userInfo"></nav>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard">
            <h2 class="mb-2">My Dashboard</h2>

            <div id="alert" class="alert"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3 id="activeIssuesCount">0</h3>
                    <p>Active Books</p>
                </div>
                <div class="stat-card">
                    <h3 id="pendingFinesAmount">$0.00</h3>
                    <p>Pending Fines</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">My Borrowed Books</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Book Title</th>
                                <th>Author</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Fine</th>
                            </tr>
                        </thead>
                        <tbody id="issuesTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">My Fines</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Book Title</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="finesTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="./js/app.js"></script> -->
    <script>
        // if (!requireAuth()) {
        //     // Will redirect to login
        // }

        async function loadDashboard() {
            const auth = getAuth();

            try {
                showLoading(true);
                const [issues, fines] = await Promise.all([
                    apiRequest(`/Issues/user/${auth.user.userId}`),
                    apiRequest(`/Fines/user/${auth.user.userId}`)
                ]);

                displayIssues(issues);
                displayFines(fines);
                updateStats(issues, fines);
            } catch (error) {
                showAlert('Failed to load dashboard: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayIssues(issues) {
            const tbody = document.getElementById('issuesTable');

            if (issues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No books issued</td></tr>';
                return;
            }

            tbody.innerHTML = issues.map(issue => `
                <tr>
                    <td>${issue.bookTitle}</td>
                    <td>${issue.bookAuthor}</td>
                    <td>${formatDate(issue.issueDate)}</td>
                    <td>${formatDate(issue.dueDate)}</td>
                    <td><span class="badge badge-${getStatusBadge(issue.status)}">${issue.status}</span></td>
                    <td>${issue.fineAmount ? formatCurrency(issue.fineAmount) : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function displayFines(fines) {
            const tbody = document.getElementById('finesTable');

            if (fines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No fines</td></tr>';
                return;
            }

            tbody.innerHTML = fines.map(fine => `
                <tr>
                    <td>${fine.bookTitle}</td>
                    <td>${formatCurrency(fine.amount)}</td>
                    <td>${fine.reason || 'N/A'}</td>
                    <td><span class="badge badge-${fine.status === 'Paid' ? 'success' : 'warning'}">${fine.status}</span></td>
                    <td>
                        ${fine.status === 'Pending'
                    ? `<button class="btn btn-sm btn-success" onclick="payFine(${fine.fineId})"><span>Pay</span></button>`
                    : 'Paid'}
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(issues, fines) {
            const activeIssues = issues.filter(i => i.status === 'Issued');
            const pendingFines = fines.filter(f => f.status === 'Pending');
            const totalFines = pendingFines.reduce((sum, f) => sum + f.amount, 0);

            document.getElementById('activeIssuesCount').textContent = activeIssues.length;
            document.getElementById('pendingFinesAmount').textContent = formatCurrency(totalFines);
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'Issued': return 'info';
                case 'Returned': return 'success';
                case 'Overdue': return 'danger';
                default: return 'info';
            }
        }

        async function payFine(fineId) {
            if (!confirm('Are you sure you want to pay this fine?')) {
                return;
            }

            try {
                showLoading(true);
                await apiRequest('/Fines/pay', 'POST', { fineId });
                showAlert('Fine paid successfully!', 'success');
                loadDashboard();
            } catch (error) {
                showAlert('Failed to pay fine: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>